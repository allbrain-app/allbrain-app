<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen Monitor</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #222; color: #fff; font-family: sans-serif; padding: 20px; }
    .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
    
    /* æ³¨æ–‡ãƒã‚±ãƒƒãƒˆ */
    .order-card { 
      background-color: #333; border: 1px solid #444; border-radius: 8px; 
      margin-bottom: 15px; padding: 15px; width: 100%;
      border-left: 5px solid #03dac6;
      transition: all 0.3s ease;
    }
    /* æ–°ç€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .new-order-flash {
      animation: flash-animation 1s ease-out;
    }
    @keyframes flash-animation {
      0% { background-color: #03dac6; }
      100% { background-color: #333; }
    }

    .order-time { font-size: 1.2rem; font-weight: bold; color: #03dac6; }
    .order-user { font-size: 0.9rem; color: #aaa; }
    .order-items { font-size: 1.1rem; margin: 10px 0; font-weight: bold; line-height: 1.6; }
    .btn-done { width: 100%; height: 50px; font-size: 1.2rem; font-weight: bold; }
    
    /* æ›´æ–°ã‚¹ãƒ”ãƒ³ */
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ã‚¹ã‚¤ãƒƒãƒ */
    .form-check-input:checked { background-color: #dc3545; border-color: #dc3545; }
    .menu-row { border-bottom: 1px solid #444; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }

    /* å®Œäº†å±¥æ­´ã‚¨ãƒªã‚¢ */
    .history-section { margin-top: 50px; border-top: 1px dashed #555; padding-top: 20px; opacity: 0.6; }
    .history-card { background-color: #2a2a2a; border: 1px solid #333; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>

<div class="container">
  <div class="header-area">
    <div class="d-flex align-items-center gap-3">
      <h2 class="m-0">ğŸ½ Kitchen Monitor</h2>
      <button class="btn btn-dark border-secondary" onclick="openOwnerModal()">ğŸ‘‘ åº—èˆ—ç®¡ç†</button>
      
      <button class="btn btn-outline-secondary" id="btn-sound" onclick="toggleSound()">
        ğŸ”‡ é€šçŸ¥OFF
      </button>
    </div>
    
    <button class="btn btn-outline-light" onclick="loadOrders(true)" id="btn-refresh">ğŸ”„ æ›´æ–°</button>
  </div>

  <div id="order-list">
    <div class="text-center text-secondary mt-5">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <div class="history-section">
    <h5>ğŸ ç›´è¿‘ã®æä¾›æ¸ˆã¿ (å±¥æ­´)</h5>
    <div id="done-list">
      <div class="small text-secondary">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
    </div>
  </div>
</div>

<div class="modal fade" id="ownerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white border-secondary">
        <h5 class="modal-title">ğŸ‘‘ åº—èˆ—ç®¡ç†ç”»é¢</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-dark text-white">
        <ul class="nav nav-tabs border-secondary mb-3" id="ownerTab" role="tablist">
          <li class="nav-item"><button class="nav-link active text-light" data-bs-toggle="tab" data-bs-target="#analysis-pane">ğŸ“Š å£²ä¸Šåˆ†æ</button></li>
          <li class="nav-item"><button class="nav-link text-light" data-bs-toggle="tab" data-bs-target="#menu-pane" onclick="fetchMenuForOwner()">ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</button></li>
        </ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="analysis-pane">
            <h6 class="text-secondary border-bottom border-secondary pb-2 mb-3">æœ¬æ—¥ã®å£²ä¸ŠçŠ¶æ³</h6>
            <div class="row text-center mb-4">
              <div class="col-6"><div class="small text-secondary">ç·å£²ä¸Š</div><div class="fs-3 fw-bold text-warning" id="owner-total-sales">Â¥0</div></div>
              <div class="col-6"><div class="small text-secondary">æ³¨æ–‡æ•°</div><div class="fs-3 fw-bold" id="owner-order-count">0<span class="fs-6">ä»¶</span></div></div>
            </div>
            <h6 class="text-secondary border-bottom border-secondary pb-2 mb-3">å•†å“åˆ¥ å£²ã‚Œè¡Œã</h6>
            <div style="height: 300px; position: relative;"><canvas id="salesChart"></canvas></div>
            <div class="mt-4 text-center"><button class="btn btn-outline-secondary w-100" onclick="fetchOwnerData()">ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button></div>
          </div>
          <div class="tab-pane fade" id="menu-pane">
            <div class="alert alert-dark border-secondary small text-secondary">ã‚¹ã‚¤ãƒƒãƒã‚’ON(èµ¤)ã«ã™ã‚‹ã¨ã€Œå£²ã‚Šåˆ‡ã‚Œã€ã«ãªã‚Šã¾ã™ã€‚</div>
            <div id="owner-menu-list"><div class="text-center py-5">èª­ã¿è¾¼ã¿ä¸­...</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="config.js"></script>

<script>
  let ownerModal;
  let salesChartInstance = null;
  let ownerMenuItems = [];
  
  // â˜…è¿½åŠ : çŠ¶æ…‹ç®¡ç†
  let previousOrderIds = new Set(); // å‰å›ã®æ³¨æ–‡IDãƒªã‚¹ãƒˆï¼ˆæ¯”è¼ƒç”¨ï¼‰
  let isSoundOn = false; // éŸ³å£°ON/OFF
  let isFirstLoad = true; // åˆå›èª­ã¿è¾¼ã¿ãƒ•ãƒ©ã‚°
  const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg"); // ãƒ•ãƒªãƒ¼ç´ æã®ãƒãƒ£ã‚¤ãƒ éŸ³

  window.onload = function() {
    if (typeof GAS_API_URL === 'undefined') { alert("config.js error"); return; }
    ownerModal = new bootstrap.Modal(document.getElementById('ownerModal'));
    
    // åˆå›ãƒ­ãƒ¼ãƒ‰
    loadOrders();
    // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ (15ç§’é–“éš”ã«çŸ­ç¸®)
    setInterval(() => loadOrders(false), 15000);
  };

  // --- â˜…å¤‰æ›´: éŸ³å£°åˆ‡ã‚Šæ›¿ãˆ ---
  function toggleSound() {
    isSoundOn = !isSoundOn;
    const btn = document.getElementById('btn-sound');
    if (isSoundOn) {
      btn.innerHTML = "ğŸ”Š é€šçŸ¥ON";
      btn.classList.replace('btn-outline-secondary', 'btn-success');
      // ä¸€åº¦ç„¡éŸ³ã§å†ç”Ÿã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã‚’è§£é™¤
      audio.volume = 0; audio.play().then(() => { audio.pause(); audio.volume = 1.0; });
    } else {
      btn.innerHTML = "ğŸ”‡ é€šçŸ¥OFF";
      btn.classList.replace('btn-success', 'btn-outline-secondary');
    }
  }

  function loadOrders(manual = false) {
    const btn = document.getElementById('btn-refresh');
    if(manual) { btn.innerHTML = "ğŸ”„ ..."; btn.classList.add('spin'); }

    fetch(GAS_API_URL + "?action=getOrders")
      .then(res => res.json())
      .then(data => {
        displayOrders(data);
        if(manual) { btn.innerHTML = "ğŸ”„ æ›´æ–°"; btn.classList.remove('spin'); }
      })
      .catch(err => {
        console.error(err);
        if(manual) btn.innerHTML = "âš ï¸ ã‚¨ãƒ©ãƒ¼";
      });
  }

  function displayOrders(orders) {
    const container = document.getElementById('order-list');
    
    if (!orders || orders.length === 0) {
      container.innerHTML = '<div class="text-center text-secondary mt-5">ç¾åœ¨ã€æœªæä¾›ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ âœ…</div>';
      previousOrderIds.clear();
      return;
    }

    // â˜…è¿½åŠ : æ–°ç€ãƒã‚§ãƒƒã‚¯ã¨å·®åˆ†æ›´æ–°
    let hasNewOrder = false;
    const currentIds = new Set(orders.map(o => o.id));

    // ã‚‚ã—å‰å›ã‚ˆã‚ŠIDãŒå¢—ãˆã¦ã„ãŸã‚‰ã€Œæ–°ç€ã‚ã‚Šã€ã¨ã¿ãªã™
    orders.forEach(order => {
      if (!previousOrderIds.has(order.id) && !isFirstLoad) {
        hasNewOrder = true;
      }
    });

    // æç”» (ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«å…¨æ›¸ãæ›ãˆã ãŒã€IDã‚’è¦‹ã¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ä¸)
    container.innerHTML = "";
    orders.forEach(order => {
      const isNew = (!previousOrderIds.has(order.id) && !isFirstLoad);
      const flashClass = isNew ? "new-order-flash" : "";
      
      const itemsHtml = order.items.map(item => `<div>ãƒ»${item}</div>`).join("");
      
      const card = `
        <div class="order-card ${flashClass}" id="card-${order.id}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="order-time">${order.time}</span>
              <span class="order-user ms-2">${order.user} æ§˜</span>
              ${isNew ? '<span class="badge bg-danger ms-2">NEW!</span>' : ''}
            </div>
          </div>
          <hr style="margin:8px 0; border-color:#555;">
          <div class="order-items">${itemsHtml}</div>
          <div class="mt-3">
            <button class="btn btn-success btn-done" onclick="completeOrder('${order.id}', '${order.user}', '${order.items.join(',')}')">æä¾›å®Œäº†</button>
          </div>
        </div>`;
      container.innerHTML += card;
    });

    // â˜…è¿½åŠ : éŸ³ã‚’é³´ã‚‰ã™
    if (hasNewOrder && isSoundOn) {
      audio.currentTime = 0;
      audio.play().catch(e => console.log("å†ç”Ÿãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ"));
    }

    // ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜
    previousOrderIds = currentIds;
    isFirstLoad = false;
  }

  // --- â˜…å¤‰æ›´: å±¥æ­´ã«æ®‹ã™å‡¦ç†ã‚’è¿½åŠ  ---
  function completeOrder(orderId, userName, itemsStr) {
    // ç¢ºèªãªã—ã§ã‚µã‚¯ã‚µã‚¯æ¶ˆã™ (èª¤æ“ä½œã¯å±¥æ­´ã§è¦‹ã‚Œã‚‹å‰æ)
    // if(!confirm("æä¾›å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;

    const card = document.getElementById(`card-${orderId}`);
    if(card) card.style.opacity = "0.3";

    const payload = { action: "completeOrder", orderId: orderId };

    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success") {
        if(card) card.remove();
        if(document.querySelectorAll('.order-list .order-card').length === 0) loadOrders();
        
        // â˜…è¿½åŠ : å±¥æ­´ã‚¨ãƒªã‚¢ã«è¿½åŠ 
        addHistory(userName, itemsStr);
      } else {
        alert("ã‚¨ãƒ©ãƒ¼: " + data.message); loadOrders();
      }
    });
  }

  function addHistory(user, items) {
    const historyList = document.getElementById('done-list');
    // "ã¾ã ã‚ã‚Šã¾ã›ã‚“" ã‚’æ¶ˆã™
    if(historyList.querySelector('.text-secondary')) historyList.innerHTML = "";
    
    const now = new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
    const html = `
      <div class="history-card">
        <div class="d-flex justify-content-between small text-muted">
          <span>${now} - ${user}</span>
          <span>å®Œäº†</span>
        </div>
        <div class="fw-bold">${items}</div>
      </div>
    `;
    // å…ˆé ­ã«è¿½åŠ 
    historyList.insertAdjacentHTML('afterbegin', html);
  }

  // --- ã‚ªãƒ¼ãƒŠãƒ¼ç®¡ç†æ©Ÿèƒ½ (åˆ†æ) ---
  function openOwnerModal() {
    const pass = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„(ãƒ‡ãƒ¢:1234)");
    if (pass !== "1234") { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); return; }
    ownerModal.show();
    fetchOwnerData(); 
  }

  function fetchOwnerData() {
    document.getElementById('owner-total-sales').innerText = "---";
    const payload = { action: "getOwnerData" };
    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json())
    .then(data => { renderOwnerDashboard(data); });
  }

  function renderOwnerDashboard(data) {
    document.getElementById('owner-total-sales').innerText = "Â¥" + data.totalSales.toLocaleString();
    document.getElementById('owner-order-count').innerText = data.orderCount;
    const ctx = document.getElementById('salesChart').getContext('2d');
    if (salesChartInstance) salesChartInstance.destroy();
    const labels = data.ranking.map(item => item.name);
    const counts = data.ranking.map(item => item.count);
    salesChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{ label: 'æ³¨æ–‡æ•°', data: counts, backgroundColor: '#03dac6', borderColor: '#03dac6', borderWidth: 1 }]
      },
      options: {
        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
        scales: { x: { beginAtZero: true, grid: { color: '#444' }, ticks: { color: '#fff', stepSize: 1 } }, y: { grid: { display: false }, ticks: { color: '#fff' } } },
        plugins: { legend: { display: false } }
      }
    });
  }

  // --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç† ---
  function fetchMenuForOwner() {
    const container = document.getElementById('owner-menu-list');
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-light"></div></div>';
    fetch(GAS_API_URL + "?action=getMenu")
      .then(res => res.json())
      .then(data => { ownerMenuItems = data; renderOwnerMenu(data); })
      .catch(err => { container.innerHTML = '<div class="text-danger text-center">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>'; });
  }

  function renderOwnerMenu(items) {
    const container = document.getElementById('owner-menu-list');
    container.innerHTML = "";
    if (items.length === 0) { container.innerHTML = '<div class="text-center text-muted">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
    let html = "";
    items.forEach(item => {
      const checked = item.isSoldOut ? "checked" : "";
      const statusText = item.isSoldOut ? "å£²åˆ‡" : "è²©å£²ä¸­";
      const statusColor = item.isSoldOut ? "text-danger fw-bold" : "text-success";
      html += `
        <div class="menu-row">
          <div><div class="fw-bold">${item.name}</div><div class="small text-secondary">${item.category} / Â¥${item.price}</div></div>
          <div class="d-flex align-items-center gap-3">
            <span class="small ${statusColor}" id="status-text-${item.id}">${statusText}</span>
            <div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="switch-${item.id}" ${checked} onchange="toggleStock('${item.id}')"></div>
          </div>
        </div>`;
    });
    container.innerHTML = html;
  }

  function toggleStock(itemId) {
    const checkbox = document.getElementById(`switch-${itemId}`);
    const isSoldOut = checkbox.checked;
    const statusTextEl = document.getElementById(`status-text-${itemId}`);
    statusTextEl.innerText = "æ›´æ–°ä¸­..."; statusTextEl.className = "small text-warning";
    const payload = { action: "updateStock", itemId: itemId, isSoldOut: isSoldOut };
    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success") {
        statusTextEl.innerText = isSoldOut ? "å£²åˆ‡" : "è²©å£²ä¸­";
        statusTextEl.className = isSoldOut ? "small text-danger fw-bold" : "small text-success";
      } else { alert("æ›´æ–°å¤±æ•—"); checkbox.checked = !isSoldOut; }
    })
    .catch(err => { alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼"); checkbox.checked = !isSoldOut; });
  }
</script>

</body>
</html>
