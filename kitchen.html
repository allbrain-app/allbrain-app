<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #222; color: #fff; font-family: sans-serif; padding: 20px; }
    .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
    
    /* æ³¨æ–‡ãƒã‚±ãƒƒãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .order-card { 
      background-color: #333; border: 1px solid #444; border-radius: 8px; 
      margin-bottom: 15px; padding: 15px; width: 100%;
      border-left: 5px solid #03dac6; /* æœªæä¾›ã‚«ãƒ©ãƒ¼ */
    }
    .order-time { font-size: 1.2rem; font-weight: bold; color: #03dac6; }
    .order-user { font-size: 0.9rem; color: #aaa; }
    .order-items { font-size: 1.1rem; margin: 10px 0; font-weight: bold; line-height: 1.6; }
    .btn-done { width: 100%; height: 50px; font-size: 1.2rem; font-weight: bold; }
    
    /* æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="container">
  <div class="header-area">
    <h2>ğŸ½ Kitchen Monitor</h2>
    <button class="btn btn-outline-light" onclick="loadOrders()" id="btn-refresh">ğŸ”„ æ›´æ–°</button>
  </div>

  <div id="order-list">
    <div class="text-center text-secondary mt-5">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
</div>

<script src="config.js"></script>

<script>
  window.onload = function() {
    if (typeof GAS_API_URL === 'undefined') { alert("config.js error"); return; }
    loadOrders();
    // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
    setInterval(loadOrders, 30000);
  };

  function loadOrders() {
    const btn = document.getElementById('btn-refresh');
    btn.innerHTML = "ğŸ”„ ...";
    btn.classList.add('spin');

    fetch(GAS_API_URL + "?action=getOrders")
      .then(res => res.json())
      .then(data => {
        displayOrders(data);
        btn.innerHTML = "ğŸ”„ æ›´æ–°";
        btn.classList.remove('spin');
      })
      .catch(err => {
        console.error(err);
        btn.innerHTML = "âš ï¸ ã‚¨ãƒ©ãƒ¼";
      });
  }

  function displayOrders(orders) {
    const container = document.getElementById('order-list');
    container.innerHTML = "";

    if (!orders || orders.length === 0) {
      container.innerHTML = '<div class="text-center text-secondary mt-5">ç¾åœ¨ã€æœªæä¾›ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ âœ…</div>';
      return;
    }

    orders.forEach(order => {
      // ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆã‚’HTMLåŒ–
      const itemsHtml = order.items.map(item => `<div>ãƒ»${item}</div>`).join("");
      
      const card = `
        <div class="order-card" id="card-${order.id}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="order-time">${order.time}</span>
              <span class="order-user ms-2">${order.user} æ§˜</span>
            </div>
          </div>
          <hr style="margin:8px 0; border-color:#555;">
          <div class="order-items">
            ${itemsHtml}
          </div>
          <div class="mt-3">
            <button class="btn btn-success btn-done" onclick="completeOrder('${order.id}')">æä¾›å®Œäº†</button>
          </div>
        </div>
      `;
      container.innerHTML += card;
    });
  }

  function completeOrder(orderId) {
    if(!confirm("æä¾›å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;

    // ç”»é¢ã‹ã‚‰å…ˆã«æ¶ˆã™ï¼ˆã‚µã‚¯ã‚µã‚¯æ„Ÿã®ãŸã‚ï¼‰
    const card = document.getElementById(`card-${orderId}`);
    if(card) card.style.opacity = "0.3";

    const payload = {
      action: "completeOrder",
      orderId: orderId
    };

    fetch(GAS_API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success") {
        if(card) card.remove();
        // ã‚‚ã—å…¨éƒ¨æ¶ˆãˆãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
        if(document.querySelectorAll('.order-card').length === 0) {
          loadOrders(); 
        }
      } else {
        alert("ã‚¨ãƒ©ãƒ¼: " + data.message);
        loadOrders(); // æˆ»ã™
      }
    })
    .catch(err => {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
      loadOrders();
    });
  }
</script>

</body>
</html>
