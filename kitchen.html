<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen Monitor</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #222; color: #fff; font-family: sans-serif; padding: 20px; }
    .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
    
    /* æ³¨æ–‡ãƒã‚±ãƒƒãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .order-card { 
      background-color: #333; border: 1px solid #444; border-radius: 8px; 
      margin-bottom: 15px; padding: 15px; width: 100%;
      border-left: 5px solid #03dac6; /* æœªæä¾›ã‚«ãƒ©ãƒ¼ */
    }
    .order-time { font-size: 1.2rem; font-weight: bold; color: #03dac6; }
    .order-user { font-size: 0.9rem; color: #aaa; }
    .order-items { font-size: 1.1rem; margin: 10px 0; font-weight: bold; line-height: 1.6; }
    .btn-done { width: 100%; height: 50px; font-size: 1.2rem; font-weight: bold; }
    
    /* æ›´æ–°ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†ç”¨ã‚¹ã‚¤ãƒƒãƒ */
    .form-check-input:checked {
      background-color: #dc3545; /* å£²ã‚Šåˆ‡ã‚Œ=èµ¤ */
      border-color: #dc3545;
    }
    .menu-row {
      border-bottom: 1px solid #444;
      padding: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header-area">
    <div class="d-flex align-items-center gap-3">
      <h2 class="m-0">ğŸ½ Kitchen Monitor</h2>
      <button class="btn btn-dark border-secondary" onclick="openOwnerModal()">ğŸ‘‘ åº—èˆ—ç®¡ç†</button>
    </div>
    <button class="btn btn-outline-light" onclick="loadOrders()" id="btn-refresh">ğŸ”„ æ›´æ–°</button>
  </div>

  <div id="order-list">
    <div class="text-center text-secondary mt-5">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>
</div>

<div class="modal fade" id="ownerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white border-secondary">
        <h5 class="modal-title">ğŸ‘‘ åº—èˆ—ç®¡ç†ç”»é¢</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-dark text-white">
        
        <ul class="nav nav-tabs border-secondary mb-3" id="ownerTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active text-light" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis-pane" type="button" role="tab">ğŸ“Š å£²ä¸Šåˆ†æ</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link text-light" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu-pane" type="button" role="tab" onclick="fetchMenuForOwner()">ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</button>
          </li>
        </ul>

        <div class="tab-content" id="ownerTabContent">
          
          <div class="tab-pane fade show active" id="analysis-pane" role="tabpanel">
            <h6 class="text-secondary border-bottom border-secondary pb-2 mb-3">æœ¬æ—¥ã®å£²ä¸ŠçŠ¶æ³</h6>
            <div class="row text-center mb-4">
              <div class="col-6">
                <div class="small text-secondary">ç·å£²ä¸Š</div>
                <div class="fs-3 fw-bold text-warning" id="owner-total-sales">Â¥0</div>
              </div>
              <div class="col-6">
                <div class="small text-secondary">æ³¨æ–‡æ•°</div>
                <div class="fs-3 fw-bold" id="owner-order-count">0<span class="fs-6">ä»¶</span></div>
              </div>
            </div>
            <h6 class="text-secondary border-bottom border-secondary pb-2 mb-3">å•†å“åˆ¥ å£²ã‚Œè¡Œã</h6>
            <div style="height: 300px; position: relative;">
               <canvas id="salesChart"></canvas>
            </div>
            <div class="mt-4 text-center">
               <button class="btn btn-outline-secondary w-100" onclick="fetchOwnerData()">ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>
            </div>
          </div>

          <div class="tab-pane fade" id="menu-pane" role="tabpanel">
            <div class="alert alert-dark border-secondary small text-secondary">
              ã‚¹ã‚¤ãƒƒãƒã‚’ON(èµ¤)ã«ã™ã‚‹ã¨ã€Œå£²ã‚Šåˆ‡ã‚Œã€ã«ãªã‚Šã¾ã™ã€‚<br>å¤‰æ›´ã¯å³åº§ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
            </div>
            <div id="owner-menu-list">
              <div class="text-center py-5">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="config.js"></script>

<script>
  let ownerModal;
  let salesChartInstance = null;
  // ç®¡ç†ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿æŒ
  let ownerMenuItems = [];

  window.onload = function() {
    if (typeof GAS_API_URL === 'undefined') { alert("config.js error"); return; }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åˆæœŸåŒ–
    ownerModal = new bootstrap.Modal(document.getElementById('ownerModal'));
    
    loadOrders();
    // 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
    setInterval(loadOrders, 30000);
  };

  // --- æ—¢å­˜: æ³¨æ–‡ãƒªã‚¹ãƒˆå–å¾— ---
  function loadOrders() {
    const btn = document.getElementById('btn-refresh');
    btn.innerHTML = "ğŸ”„ ...";
    btn.classList.add('spin');

    fetch(GAS_API_URL + "?action=getOrders")
      .then(res => res.json())
      .then(data => {
        displayOrders(data);
        btn.innerHTML = "ğŸ”„ æ›´æ–°";
        btn.classList.remove('spin');
      })
      .catch(err => {
        console.error(err);
        btn.innerHTML = "âš ï¸ ã‚¨ãƒ©ãƒ¼";
      });
  }

  function displayOrders(orders) {
    const container = document.getElementById('order-list');
    container.innerHTML = "";
    if (!orders || orders.length === 0) {
      container.innerHTML = '<div class="text-center text-secondary mt-5">ç¾åœ¨ã€æœªæä¾›ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ âœ…</div>';
      return;
    }
    orders.forEach(order => {
      const itemsHtml = order.items.map(item => `<div>ãƒ»${item}</div>`).join("");
      const card = `
        <div class="order-card" id="card-${order.id}">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="order-time">${order.time}</span>
              <span class="order-user ms-2">${order.user} æ§˜</span>
            </div>
          </div>
          <hr style="margin:8px 0; border-color:#555;">
          <div class="order-items">${itemsHtml}</div>
          <div class="mt-3">
            <button class="btn btn-success btn-done" onclick="completeOrder('${order.id}')">æä¾›å®Œäº†</button>
          </div>
        </div>`;
      container.innerHTML += card;
    });
  }

  function completeOrder(orderId) {
    if(!confirm("æä¾›å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const card = document.getElementById(`card-${orderId}`);
    if(card) card.style.opacity = "0.3";
    const payload = { action: "completeOrder", orderId: orderId };

    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success") {
        if(card) card.remove();
        if(document.querySelectorAll('.order-card').length === 0) loadOrders(); 
      } else { alert("ã‚¨ãƒ©ãƒ¼: " + data.message); loadOrders(); }
    });
  }

  // --- ã‚ªãƒ¼ãƒŠãƒ¼ç®¡ç†æ©Ÿèƒ½ (åˆ†æ) ---
  function openOwnerModal() {
    const pass = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„(ãƒ‡ãƒ¢:1234)");
    if (pass !== "1234") { alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); return; }
    ownerModal.show();
    fetchOwnerData(); // ã¾ãšã¯åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
  }

  function fetchOwnerData() {
    document.getElementById('owner-total-sales').innerText = "---";
    const payload = { action: "getOwnerData" };
    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json())
    .then(data => { renderOwnerDashboard(data); });
  }

  function renderOwnerDashboard(data) {
    document.getElementById('owner-total-sales').innerText = "Â¥" + data.totalSales.toLocaleString();
    document.getElementById('owner-order-count').innerText = data.orderCount;
    const ctx = document.getElementById('salesChart').getContext('2d');
    if (salesChartInstance) salesChartInstance.destroy();
    const labels = data.ranking.map(item => item.name);
    const counts = data.ranking.map(item => item.count);
    salesChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{ label: 'æ³¨æ–‡æ•°', data: counts, backgroundColor: '#03dac6', borderColor: '#03dac6', borderWidth: 1 }]
      },
      options: {
        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
        scales: { x: { beginAtZero: true, grid: { color: '#444' }, ticks: { color: '#fff', stepSize: 1 } }, y: { grid: { display: false }, ticks: { color: '#fff' } } },
        plugins: { legend: { display: false } }
      }
    });
  }

  // --- â˜…è¿½åŠ : ã‚ªãƒ¼ãƒŠãƒ¼ç®¡ç†æ©Ÿèƒ½ (ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç† Step2) ---
  function fetchMenuForOwner() {
    const container = document.getElementById('owner-menu-list');
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-light"></div></div>';

    // å®¢ç”¨ã®getMenu APIã‚’ãã®ã¾ã¾å†åˆ©ç”¨
    fetch(GAS_API_URL + "?action=getMenu")
      .then(res => res.json())
      .then(data => {
        ownerMenuItems = data; // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
        renderOwnerMenu(data);
      })
      .catch(err => {
        container.innerHTML = '<div class="text-danger text-center">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
      });
  }

  function renderOwnerMenu(items) {
    const container = document.getElementById('owner-menu-list');
    container.innerHTML = "";
    
    if (items.length === 0) {
      container.innerHTML = '<div class="text-center text-muted">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    let html = "";
    items.forEach(item => {
      // isSoldOutãŒtrueãªã‚‰checked
      const checked = item.isSoldOut ? "checked" : "";
      const statusText = item.isSoldOut ? "å£²åˆ‡" : "è²©å£²ä¸­";
      const statusColor = item.isSoldOut ? "text-danger fw-bold" : "text-success";

      html += `
        <div class="menu-row">
          <div>
            <div class="fw-bold">${item.name}</div>
            <div class="small text-secondary">${item.category} / Â¥${item.price}</div>
          </div>
          <div class="d-flex align-items-center gap-3">
            <span class="small ${statusColor}" id="status-text-${item.id}">${statusText}</span>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="switch-${item.id}" 
                ${checked} onchange="toggleStock('${item.id}')">
            </div>
          </div>
        </div>
      `;
    });
    container.innerHTML = html;
  }

  function toggleStock(itemId) {
    const checkbox = document.getElementById(`switch-${itemId}`);
    const isSoldOut = checkbox.checked;
    
    // UIã‚’å³æ™‚æ›´æ–° (æ¥½è¦³çš„æ›´æ–°)
    const statusTextEl = document.getElementById(`status-text-${itemId}`);
    statusTextEl.innerText = isSoldOut ? "æ›´æ–°ä¸­..." : "æ›´æ–°ä¸­...";
    statusTextEl.className = "small text-warning";

    const payload = {
      action: "updateStock",
      itemId: itemId,
      isSoldOut: isSoldOut
    };

    fetch(GAS_API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success") {
        // å®Œäº†è¡¨ç¤º
        statusTextEl.innerText = isSoldOut ? "å£²åˆ‡" : "è²©å£²ä¸­";
        statusTextEl.className = isSoldOut ? "small text-danger fw-bold" : "small text-success";
      } else {
        alert("æ›´æ–°å¤±æ•—");
        // å…ƒã«æˆ»ã™
        checkbox.checked = !isSoldOut;
      }
    })
    .catch(err => {
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");
      checkbox.checked = !isSoldOut;
    });
  }

</script>

</body>
</html>
