<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen Monitor</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #222; color: #fff; font-family: sans-serif; padding: 20px; }
    .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
    
    /* æ³¨æ–‡ã‚«ãƒ¼ãƒ‰ */
    .order-card { background-color: #333; border: 1px solid #444; border-radius: 8px; margin-bottom: 15px; padding: 15px; width: 100%; border-left: 5px solid #03dac6; transition: all 0.3s ease; }
    .new-order-flash { animation: flash-animation 1s ease-out; }
    @keyframes flash-animation { 0% { background-color: #03dac6; } 100% { background-color: #333; } }
    
    /* â˜…å¤‰æ›´: ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã‚’å¼·èª¿ */
    .order-table { font-size: 1.4rem; font-weight: bold; color: #fff; background-color: #03dac6; color:#000; padding: 2px 8px; border-radius: 4px; margin-right: 10px;}
    .order-time { font-size: 1.0rem; color: #aaa; margin-left: 10px;}
    .order-user { font-size: 0.9rem; color: #aaa; display: block; margin-top: 5px;}
    .order-items { font-size: 1.2rem; margin: 10px 0; font-weight: bold; }
    .btn-done { width: 100%; height: 50px; font-size: 1.2rem; font-weight: bold; }

    /* ä¼šè¨ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ */
    .checkout-card { background-color: #4a1c1c; border: 1px solid #ff5555; border-radius: 8px; margin-bottom: 15px; padding: 15px; border-left: 8px solid #ff5555; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 85, 85, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(255, 85, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 85, 85, 0); } }
    .checkout-table { font-size: 1.5rem; font-weight: bold; color: #fff; background-color: #dc3545; padding: 2px 10px; border-radius: 4px; }
    .checkout-total { font-size: 1.5rem; font-weight: bold; color: #ffaeae; }

    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    .form-check-input:checked { background-color: #dc3545; border-color: #dc3545; }
    .menu-row { border-bottom: 1px solid #444; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
    .history-section { margin-top: 50px; border-top: 1px dashed #555; padding-top: 20px; opacity: 0.6; }
    .history-card { background-color: #2a2a2a; border: 1px solid #333; margin-bottom: 10px; padding: 10px; border-radius: 5px; }
  </style>
</head>
<body>

<div class="container">
  <div class="header-area">
    <div class="d-flex align-items-center gap-3">
      <h2 class="m-0">ğŸ½ Kitchen Monitor</h2>
      <button class="btn btn-dark border-secondary" onclick="openOwnerModal()">ğŸ‘‘ åº—èˆ—ç®¡ç†</button>
      <button class="btn btn-outline-secondary" id="btn-sound" onclick="toggleSound()">ğŸ”‡ é€šçŸ¥OFF</button>
    </div>
    <button class="btn btn-outline-light" onclick="loadOrders(true)" id="btn-refresh">ğŸ”„ æ›´æ–°</button>
  </div>

  <div id="checkout-section" style="display:none;">
    <h4 class="text-danger border-bottom border-danger pb-2 mb-3">ğŸ’¸ ä¼šè¨ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h4>
    <div id="checkout-list"></div>
    <hr class="border-secondary my-4">
  </div>

  <div id="order-list">
    <div class="text-center text-secondary mt-5">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <div class="history-section">
    <h5>ğŸ ç›´è¿‘ã®å±¥æ­´</h5>
    <div id="done-list"><div class="small text-secondary">ã¾ã ã‚ã‚Šã¾ã›ã‚“</div></div>
  </div>
</div>

<div class="modal fade" id="ownerModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white border-secondary">
        <h5 class="modal-title">ğŸ‘‘ åº—èˆ—ç®¡ç†ç”»é¢</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-dark text-white">
        <ul class="nav nav-tabs border-secondary mb-3"><li class="nav-item"><button class="nav-link active text-light" data-bs-toggle="tab" data-bs-target="#analysis-pane">ğŸ“Š å£²ä¸Šåˆ†æ</button></li><li class="nav-item"><button class="nav-link text-light" data-bs-toggle="tab" data-bs-target="#menu-pane" onclick="fetchMenuForOwner()">ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</button></li></ul>
        <div class="tab-content">
          <div class="tab-pane fade show active" id="analysis-pane">
            <div class="row text-center mb-4"><div class="col-6"><div class="small text-secondary">ç·å£²ä¸Š</div><div class="fs-3 fw-bold text-warning" id="owner-total-sales">Â¥0</div></div><div class="col-6"><div class="small text-secondary">æ³¨æ–‡æ•°</div><div class="fs-3 fw-bold" id="owner-order-count">0ä»¶</div></div></div>
            <div style="height: 300px; position: relative;"><canvas id="salesChart"></canvas></div>
            <div class="mt-4 text-center"><button class="btn btn-outline-secondary w-100" onclick="fetchOwnerData()">æ›´æ–°</button></div>
          </div>
          <div class="tab-pane fade" id="menu-pane">
            <div class="alert alert-dark border-secondary small text-secondary">èµ¤ã‚¹ã‚¤ãƒƒãƒï¼å£²ã‚Šåˆ‡ã‚Œ</div>
            <div id="owner-menu-list"><div class="text-center py-5">èª­ã¿è¾¼ã¿ä¸­...</div></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="config.js"></script>

<script>
  let ownerModal;
  let salesChartInstance = null;
  let ownerMenuItems = [];
  let previousOrderIds = new Set();
  let previousCheckoutIds = new Set();
  let isSoundOn = false;
  let isFirstLoad = true;
  const audio = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  const checkoutAudio = new Audio("https://actions.google.com/sounds/v1/alarms/mechanic_clock_ring.ogg");

  window.onload = function() {
    if (typeof GAS_API_URL === 'undefined') { alert("config.js error"); return; }
    ownerModal = new bootstrap.Modal(document.getElementById('ownerModal'));
    loadOrders();
    setInterval(() => loadOrders(false), 15000);
  };

  function toggleSound() {
    isSoundOn = !isSoundOn;
    const btn = document.getElementById('btn-sound');
    if (isSoundOn) {
      btn.innerHTML = "ğŸ”Š é€šçŸ¥ON"; btn.classList.replace('btn-outline-secondary', 'btn-success');
      audio.volume = 0; audio.play().then(()=>{audio.pause();audio.volume=1.0;});
    } else {
      btn.innerHTML = "ğŸ”‡ é€šçŸ¥OFF"; btn.classList.replace('btn-success', 'btn-outline-secondary');
    }
  }

  function loadOrders(manual = false) {
    const btn = document.getElementById('btn-refresh');
    if(manual) { btn.innerHTML = "ğŸ”„ ..."; btn.classList.add('spin'); }
    fetch(GAS_API_URL + "?action=getOrders")
      .then(res => res.json())
      .then(data => {
        displayOrders(data.orders);
        displayCheckouts(data.checkouts);
        if(manual) { btn.innerHTML = "ğŸ”„ æ›´æ–°"; btn.classList.remove('spin'); }
      })
      .catch(err => { console.error(err); if(manual) btn.innerHTML = "âš ï¸ ã‚¨ãƒ©ãƒ¼"; });
  }

  function displayOrders(orders) {
    const container = document.getElementById('order-list');
    const currentIds = new Set(orders.map(o => o.id));
    let hasNew = false;
    
    if (!orders || orders.length === 0) {
      container.innerHTML = '<div class="text-center text-secondary mt-5">ç¾åœ¨ã€æœªæä¾›ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ âœ…</div>';
    } else {
      let html = "";
      orders.forEach(order => {
        const isNew = (!previousOrderIds.has(order.id) && !isFirstLoad);
        if(isNew) hasNew = true;
        const flashClass = isNew ? "new-order-flash" : "";
        const itemsHtml = order.items.map(item => `<div>ãƒ»${item}</div>`).join("");
        // â˜…å¤‰æ›´: ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã‚’è¡¨ç¤º
        html += `
          <div class="order-card ${flashClass}" id="card-${order.id}">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <span class="order-table">Table ${order.tableId}</span>
                <span class="order-time">${order.time}</span>
                <span class="order-user">${order.user} æ§˜</span>
                ${isNew?'<span class="badge bg-danger ms-2">NEW!</span>':''}
              </div>
            </div>
            <hr style="margin:8px 0; border-color:#555;"><div class="order-items">${itemsHtml}</div>
            <div class="mt-3"><button class="btn btn-success btn-done" onclick="completeOrder('${order.id}','${order.user}','${order.items.join(',')}')">æä¾›å®Œäº†</button></div>
          </div>`;
      });
      container.innerHTML = html;
    }

    if(hasNew && isSoundOn) { audio.currentTime=0; audio.play().catch(e=>{}); }
    previousOrderIds = currentIds;
  }

  function displayCheckouts(checkouts) {
    const section = document.getElementById('checkout-section');
    const container = document.getElementById('checkout-list');
    const currentIds = new Set(checkouts.map(c => c.userId)); 
    let hasNew = false;

    if (!checkouts || checkouts.length === 0) {
      section.style.display = 'none';
      previousCheckoutIds.clear();
      return;
    }

    section.style.display = 'block';
    let html = "";
    checkouts.forEach(c => {
      const isNew = (!previousCheckoutIds.has(c.userId) && !isFirstLoad);
      if(isNew) hasNew = true;
      // â˜…å¤‰æ›´: ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã‚’è¡¨ç¤º
      html += `
        <div class="checkout-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
             <div>
               <span class="checkout-table">Table ${c.tableId}</span>
               <span class="ms-2 fs-5 fw-bold">${c.user} æ§˜</span>
             </div>
             <div class="checkout-total">Â¥${c.total.toLocaleString()}</div>
          </div>
          <div class="text-white-50 small mb-3">ä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™</div>
          <button class="btn btn-danger w-100 fw-bold py-3" onclick="confirmPayment('${c.userId}', '${c.user}')">ä¼šè¨ˆæ¸ˆ (æ¶ˆè¾¼)</button>
        </div>
      `;
    });
    container.innerHTML = html;

    if(hasNew && isSoundOn) { checkoutAudio.currentTime=0; checkoutAudio.play().catch(e=>{}); }
    previousCheckoutIds = currentIds;
    isFirstLoad = false;
  }

  function completeOrder(orderId, user, items) {
    const card = document.getElementById(`card-${orderId}`);
    if(card) card.style.opacity = "0.3";
    const payload = { action: "completeOrder", orderId: orderId };
    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success") {
        if(card) card.remove();
        if(document.querySelectorAll('.order-card').length === 0) loadOrders();
        addHistory(user, items);
      } else { alert("ã‚¨ãƒ©ãƒ¼"); loadOrders(); }
    });
  }

  function confirmPayment(userId, userName) {
    if(!confirm(`${userName}æ§˜ã®ä¼šè¨ˆã‚’å®Œäº†ã—ã€å±¥æ­´ã¸ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const payload = { action: "confirmPayment", userId: userId };
    fetch(GAS_API_URL, { method: "POST", body: JSON.stringify(payload) })
    .then(res => res.json())
    .then(data => {
      if(data.status === "success") {
        alert("ä¼šè¨ˆå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ");
        loadOrders(); 
      } else { alert("ã‚¨ãƒ©ãƒ¼: " + data.message); }
    });
  }

  function addHistory(user, items) {
    const list = document.getElementById('done-list');
    if(list.querySelector('.text-secondary')) list.innerHTML = "";
    const now = new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'});
    const html = `<div class="history-card"><div class="d-flex justify-content-between small text-muted"><span>${now} - ${user}</span><span>å®Œäº†</span></div><div class="fw-bold">${items}</div></div>`;
    list.insertAdjacentHTML('afterbegin', html);
  }

  // ã‚ªãƒ¼ãƒŠãƒ¼æ©Ÿèƒ½ç³»ï¼ˆå¤‰æ›´ãªã—ï¼‰
  function openOwnerModal() { const p=prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰(1234)"); if(p!=="1234")return; ownerModal.show(); fetchOwnerData(); }
  function fetchOwnerData() { document.getElementById('owner-total-sales').innerText="---"; fetch(GAS_API_URL,{method:"POST",body:JSON.stringify({action:"getOwnerData"})}).then(r=>r.json()).then(d=>renderOwnerDashboard(d)); }
  function renderOwnerDashboard(d) { document.getElementById('owner-total-sales').innerText="Â¥"+d.totalSales.toLocaleString(); document.getElementById('owner-order-count').innerText=d.orderCount; const c=document.getElementById('salesChart').getContext('2d'); if(salesChartInstance)salesChartInstance.destroy(); salesChartInstance=new Chart(c,{type:'bar',data:{labels:d.ranking.map(i=>i.name),datasets:[{label:'ç‚¹æ•°',data:d.ranking.map(i=>i.count),backgroundColor:'#03dac6'}]},options:{indexAxis:'y',scales:{x:{beginAtZero:true}}}}); }
  function fetchMenuForOwner() { fetch(GAS_API_URL+"?action=getMenu").then(r=>r.json()).then(d=>{renderOwnerMenu(d);}).catch(e=>{}); }
  function renderOwnerMenu(items) { 
    const c=document.getElementById('owner-menu-list'); c.innerHTML=""; 
    items.forEach(i=>{ 
      const ch=i.isSoldOut?"checked":""; const st=i.isSoldOut?"å£²åˆ‡":"è²©å£²ä¸­"; const cl=i.isSoldOut?"text-danger":"text-success";
      c.innerHTML+=`<div class="menu-row"><div><div class="fw-bold">${i.name}</div></div><div class="d-flex align-items-center gap-3"><span class="small ${cl}" id="st-${i.id}">${st}</span><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="sw-${i.id}" ${ch} onchange="tgStock('${i.id}')"></div></div></div>`;
    }); 
  }
  function tgStock(id) { 
    const ck=document.getElementById(`sw-${id}`); const st=document.getElementById(`st-${id}`);
    const v=ck.checked; st.innerText="..."; 
    fetch(GAS_API_URL,{method:"POST",body:JSON.stringify({action:"updateStock",itemId:id,isSoldOut:v})})
    .then(r=>r.json()).then(d=>{ st.innerText=v?"å£²åˆ‡":"è²©å£²ä¸­"; st.className=v?"small text-danger":"small text-success"; });
  }
</script>

</body>
</html>
